<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <title>Snippet Library</title>
  </head>
  <body>
    <nav>
      <input type="text" id="searchInput" placeholder="Search snippets..." />
      <button id="searchBtn">Search</button>
      <button id="showAllBtn">Show All</button>
    </nav>

    <main>
      <form id="snippetForm">
        <h2>Add a New Snippet</h2>
        <textarea
          id="codeInput"
          placeholder="Paste your code snippet here..."
        ></textarea>
        <br />
        <button type="submit">Submit Snippet</button>
        <div id="responseMsg"></div>
      </form>

      <div id="searchResults" style="display: none">
        <h2>Search Results</h2>
        <div id="searchResultsList"></div>
      </div>

      <div id="snippetsList" style="display: none">
        <h2>All Snippets</h2>
        <div id="allSnippetsList"></div>
      </div>
    </main>

    <script>
      const form = document.getElementById("snippetForm");
      const codeInput = document.getElementById("codeInput");
      const responseMsg = document.getElementById("responseMsg");

      const searchBtn = document.getElementById("searchBtn");
      const searchInput = document.getElementById("searchInput");
      const searchResults = document.getElementById("searchResults");
      const searchResultsList = document.getElementById("searchResultsList");

      const showAllBtn = document.getElementById("showAllBtn");
      const snippetsList = document.getElementById("snippetsList");
      const allSnippetsList = document.getElementById("allSnippetsList");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const code = codeInput.value.trim();
        if (!code) {
          responseMsg.textContent = "Please enter a code snippet.";
          return;
        }

        try {
          const response = await fetch("/add_snippet", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
          });

          const result = await response.json();

          if (response.ok) {
            responseMsg.innerHTML = `
              Snippet saved with ID: ${result.id}<br>
              Tags: ${
                result.tags &&
                Array.isArray(result.tags) &&
                result.tags.length > 0
                  ? result.tags.join(", ")
                  : "(none)"
              }<br>
              Beschreibung: ${result.description || "(none)"}
            `;
            codeInput.value = "";
          } else {
            responseMsg.textContent = `Error: ${
              result.error || "Unknown error"
            }`;
          }
        } catch (err) {
          responseMsg.textContent = "Failed to submit snippet.";
          console.error(err);
        }
      });

      searchBtn.addEventListener("click", async () => {
        const q = searchInput.value.trim();
        if (!q) {
          searchResults.textContent = "Please enter a search term.";
          return;
        }

        snippetsList.style.display = "none";
        searchResults.style.display = "block";
        searchResultsList.textContent = "Searching...";

        try {
          const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
          const snippets = await res.json();

          if (snippets.length === 0) {
            searchResultsList.textContent = "No snippets found.";
            return;
          }

          searchResultsList.innerHTML = "";
          snippets.forEach((snip) => {
            const snippetDiv = document.createElement("div");
            snippetDiv.textContent = `ID: ${snip.id}\nTags: ${
              snip.tags || "(none)"
            }\nCode:\n${snip.code}`;
            searchResultsList.appendChild(snippetDiv);
          });
        } catch (err) {
          searchResultsList.textContent = "Search failed.";
          console.error(err);
        }
      });

      showAllBtn.addEventListener("click", async () => {
        searchResults.style.display = "none";
        snippetsList.style.display = "block";

        try {
          const res = await fetch("/snippets");
          const snippets = await res.json();

          if (snippets.length === 0) {
            allSnippetsList.textContent = "No snippets stored yet.";
            return;
          }

          allSnippetsList.innerHTML = "";
          snippets.forEach((snip) => {
            const snippetDiv = document.createElement("div");
            snippetDiv.textContent = `ID: ${snip.id}\nTags: ${
              snip.tags || "(none)"
            }\nCode:\n${snip.code}`;
            allSnippetsList.appendChild(snippetDiv);
          });
        } catch (err) {
          allSnippetsList.textContent = "Failed to load snippets.";
          console.error(err);
        }
      });
    </script>
  </body>
</html>
